AWSTemplateFormatVersion: 2010-09-09
Description: Creates a new VPC and RD GW host, and deploys Sitecore into the newly created VPC (qs-1qjogjg57)
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network configuration
        Parameters:
          - VPCCIDR
          - PrivateSubnet1ACIDR
          - PrivateSubnet2ACIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - AvailabilityZones
      - Label:
          default: RDGW configuration
        Parameters:
          - AdminUser
          - AdminPassword
          - DomainDNSName
          - NumberOfRDGWHosts
          - RDGWInstanceType
          - RDGWCIDR
          - KeyPairName
      - Label:
          default: Sitecore Networking Configuration
        Parameters:
          - CDDNSName
          - CMDNSName
          - ISDNSName
          - IntDNS
          - ExternalCertificateARN
      - Label:
          default: Sitecore Configuration
        Parameters:
          - CDMinSize
          - CDMaxSize
          - CDDesiredCapacity
          - CDInstanceType
          - CDScalingMetric
          - CDScalingMetricValue
          - CMMinSize
          - CMMaxSize
          - CMInstanceType
          - CMScalingMetric
          - CMScalingMetricValue
          - SitecoreKeyPair
          - SitecorePrefix
          - SitecoreS3Bucket
          - SCResourcesPrefix
          - SCLicensePrefix
          - SOLRCorePrefix
          - SOLRUrl
          - EnvironmentType
          - SCLogLevel
          - CorsOrigins
          - EmailNotifications
          - LambdaZipsBucketName
      - Label:
          default: SQL Server configuration
        Parameters:
          - DBInstanceClass
          - DBAutoMinorVersionUpgrade
          - SQLEngineEdition
          - SQLEngineVersion
          - VolumeSize
          - VolumeType
          - VolumeIops
          - BackupRetentionPeriod
      - Label:
          default: Redis ElastiCache configuration
        Parameters:
         - CacheNodeType
         - RedisPort
      - Label:
          default: AWS Quick Start configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
    ParameterLabels:
    # VPC
      VPCCIDR:
        default: VPC CIDR
      PrivateSubnet1ACIDR:
        default: Private subnet 1A CIDR
      PrivateSubnet2ACIDR:
        default: Private subnet 2A CIDR
      PublicSubnet1CIDR:
        default: Public subnet 1 CIDR
      PublicSubnet2CIDR:
        default: Public subnet 2 CIDR
      AvailabilityZones:
        default: Availability Zones
      ExternalCertificateARN:
        default: External Amazon Certificate Manager ARN
    #RDGW
      AdminUser:
        default: RD Gateway Admin User Name
      AdminPassword:
        default: RD Gateway Admin Password
      DomainDNSName:
        default: RD Gateway Domain DNS Name
      NumberOfRDGWHosts:
        default: Number of RD Gateway hosts
      RDGWInstanceType:
        default: RD Gateway Instance Type
      RDGWCIDR:
        default: Allowed RD Gateway External Access CIDR
      KeyPairName:
        default: Key pair name for the RD Gateway
    # Sitecore Configuration
      CDDNSName:
        default: DNS name for Content Delivery Role
      CMDNSName:
        default: DNS name for Content Management Role
      ISDNSName:
        default: DNS name for Identity Server Role
      IntDNS:
        default: '[OPTIONAL] Internal DNS suffix for the Sitecore installation'
      CDMinSize:
        default: Min number of Content Delivery instances # Currently applied to all instances
      CDMaxSize:
        default: Max number of Content Delivery instances # Currently applied to all instances
      CDDesiredCapacity:
        default: The current number of desired Content Delivery instances # Currently applied to all instances
      CDInstanceType:
        default: The instance type to be used for the Content Delivery instances # Currently applied to all instances
      CDScalingMetric:
        default: The metric used to determine scalling of the Content Delivery role
      CDScalingMetricValue:
        default: The metric value used to determine scalling of the Content Delivery role
      CMMinSize:
        default: Min number of Content Management instance
      CMMaxSize:
        default: Max number of Content Management instance
      CMInstanceType:
        default: The instance type to be used for the Content Management instances
      CMScalingMetric:
        default: The metric used to determine scalling of the Content Management role
      CMScalingMetricValue:
        default: The metric value used to determine scalling of the Content Management role
      SitecoreKeyPair:
        default: EC2 Key Pair for Sitecore instances
      SitecorePrefix:
        default: The Prefix to be used for the Sitecore installation
      SitecoreS3Bucket:
        default: S3 Bucket where Sitecore artifacts are located (Resource files, licence files.) This deployment will put objects into this bucket.
      SCResourcesPrefix:
        default: "The prefix where Sitecore installation files are located (eg: sitecorefiles/)"
      SCLicensePrefix:
        default: "The prefix where the sitecore license.zip is located (eg: licence/)"
      SOLRCorePrefix:
        default: The prefix used for the SOLR Cores
      SOLRUrl:
        default: The Url for the SOLR deployment
      EnvironmentType:
        default: The Sitecore Environment Type
      SCLogLevel:
        default: The Sitecore Log Level
      CorsOrigins:
        default: The Sitecore Cors Origins
      EmailNotifications:
        default: The email address for receiving notifications on instance scaling.
      LambdaZipsBucketName:
        default: '[OPTIONAL] The name of the S3 bucket where the Lambda zip files should be placed. If you leave this parameter blank, an S3 bucket will be created.'
      DBInstanceClass:
        default: To be udpated
      DBAutoMinorVersionUpgrade:
        default: Database auto minor version upgrade
      SQLEngineEdition:
        default: MSSQL database engine edition
      SQLEngineVersion:
        default: MSSQL database engine version
      VolumeIops:
        default: Data volume IOPS
      VolumeSize:
        default: Data volume size
      VolumeType:
        default: Data volume type
      BackupRetentionPeriod:
        default: Retention Period
    # Redis Configuration
      CacheNodeType:
        default: Redis cache node type
      RedisPort:
        default: Redis Port
    #Quick Start Configuration
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      
Parameters:
#VPC
  VPCCIDR:
    Description: The CIDR block for the VPC.
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/16
    Type: String
  PrivateSubnet1ACIDR:
    Description: The CIDR block for private subnet 1 located in Availability Zone 1.
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/19
    Type: String
  PrivateSubnet2ACIDR:
    Description: The CIDR block for private subnet 2 located in Availability Zone 2.
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Type: String 
  PublicSubnet1CIDR:
    Description: The CIDR block for the public (DMZ) subnet 1 located in Availability Zone 1.
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.128.0/20
    Type: String
  PublicSubnet2CIDR:
    Description: The CIDR block for the public (DMZ) subnet 2 located in Availability Zone 2.
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.144.0/20
    Type: String
  AvailabilityZones:
    Description: "List of Availability Zones to use for the subnets in the VPC. Note: The logical order is preserved."
    Type: List<AWS::EC2::AvailabilityZone::Name>
  ExternalCertificateARN:
    Type: String
    Description: This is the certificate which will be used on the external facing load balancer (or potentially cloudfront) 
#RDGW
  AdminUser:
    Description: User name for the new local administrator account
    Type: String
    Default: StackAdmin
    MinLength: '5'
    MaxLength: '25'
    AllowedPattern: "[a-zA-Z0-9]*"
  AdminPassword:
    Description: Password for the administrative account. Must be at least 8 characters containing letters, numbers and symbols
    Type: String
    MinLength: '8'
    MaxLength: '32'
    AllowedPattern: "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*"
    NoEcho: true
  DomainDNSName:
    Description: Fully qualified domain name (FQDN) e.g. example.com
    Type: String
    Default: example.com
    MinLength: '2'
    MaxLength: '255'
    AllowedPattern: "[a-zA-Z0-9\\-]+\\..+"
  NumberOfRDGWHosts:
    AllowedValues: 
      - '1'
      - '2'
    Default: '1'
    Description: Enter the number of Remote Desktop Gateway hosts to create
    Type: String
  RDGWInstanceType:
    Description: Amazon EC2 instance type for the first Remote Desktop Gateway instance
    Type: String
    Default: t2.large
    AllowedValues:
      - t2.large
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
  RDGWCIDR:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$"
    Description: Allowed CIDR Block for external access to the Remote Desktop Gateways
    Type: String
  KeyPairName:
    Description: Public/private key pairs allow you to securely connect to your instance after it launches
    Type: AWS::EC2::KeyPair::KeyName
#Sitecore
  CDDNSName:
    Type: String
    Description: DNS name for Content Delivery Role
  CMDNSName:
    Type: String
    Description: DNS name for Content Managment Role
  ISDNSName:
    Type: String
    Description: DNS name for Identity Server Role
  IntDNS:
    Type: String
    Description: Internal DNS name. If left blank, one will be generated for you
  CDMinSize:
    Type: String
    Default: '1'
    Description: The minimum number of Content Delivery instances to be available (this currently applies to ALL roles)
  CDMaxSize:
    Type: String
    Default: '2'
    Description: The maximum number of Content Delivery instances to be available (this currently applies to ALL roles)
  CDDesiredCapacity:
    Type: String
    Default: '1'
    Description: The desired number of Content Delivery instances to be available (this currently applies to ALL roles)
  CDInstanceType:
    AllowedValues:
    - t2.micro
    - t2.small
    - t2.medium
    - t2.large
    - m4.large
    - m4.xlarge
    - m4.2xlarge
    - m4.4xlarge
    - m4.10xlarge
    - m3.medium
    - m3.large
    - m3.xlarge
    - m3.2xlarge
    - c4.large
    - c4.xlarge
    - c4.2xlarge
    - c4.4xlarge
    - c4.8xlarge
    - c3.large
    - c3.xlarge
    - c3.2xlarge
    - c3.4xlarge
    - c3.8xlarge
    - r3.large
    - r3.xlarge
    - r3.2xlarge
    - r3.4xlarge
    - r3.8xlarge
    - i2.xlarge
    - i2.2xlarge
    - i2.4xlarge
    - i2.8xlarge
    ConstraintDescription: Choose an instance type. m3.medium or larger recommended.
    Default: m4.large
    Description: Web server instance type (this currently applies to ALL roles)
    Type: String
  CDScalingMetric:
    Description: The metric used to determine scalling of the Content Delivery role
    Default: ASGAverageCPUUtilization
    AllowedValues:
      - ASGAverageCPUUtilization 
      - ASGAverageNetworkIn 
      - ALBRequestCountPerTarget 
    Type: String
  CDScalingMetricValue:
    Description: The value required for the Scaling Metric (For ASGAverageNetworkIn this value is in bytes)
    Default: 300
    Type: Number
  CMMinSize:
    Type: String
    Default: '1'
    Description: The minimum number of Content Management instances to be available (this currently applies to ALL roles)
  CMMaxSize:
    Type: String
    Default: '2'
    Description: The maximum number of Content Management instances to be available (this currently applies to ALL roles)
  CMInstanceType:
    AllowedValues:
    - m4.large
    - m4.xlarge
    - m4.2xlarge
    - m4.4xlarge
    - m4.10xlarge
    - m3.medium
    - m3.large
    - m3.xlarge
    - m3.2xlarge
    - c4.large
    - c4.xlarge
    - c4.2xlarge
    - c4.4xlarge
    - c4.8xlarge
    - c3.large
    - c3.xlarge
    - c3.2xlarge
    - c3.4xlarge
    - c3.8xlarge
    - r3.large
    - r3.xlarge
    - r3.2xlarge
    - r3.4xlarge
    - r3.8xlarge
    - i2.xlarge
    - i2.2xlarge
    - i2.4xlarge
    - i2.8xlarge
    ConstraintDescription: Choose an instance type. m3.medium or larger recommended.
    Default: m4.large
    Description: Web server instance type for the Content Management role
    Type: String
  CMScalingMetric:
    Description: The metric used to determine scalling of the Content Management role
    Default: ASGAverageCPUUtilization
    AllowedValues:
      - ASGAverageCPUUtilization 
      - ASGAverageNetworkIn 
      - ALBRequestCountPerTarget 
    Type: String
  CMScalingMetricValue:
    Description: The value required for the Scaling Metric (For ASGAverageNetworkIn this value is in bytes)
    Default: 300
    Type: Number
  SitecoreKeyPair:
    Type: AWS::EC2::KeyPair::KeyName
    Description: The EC2 Key Pair to use with the Sitecore instances
  SitecorePrefix: 
    Type: String
    Description: The prefix to be used for the sitecore installation
    MinLength: 1
    MaxLength: 8
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Sitecore prefix can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
  SitecoreS3Bucket:
    Type: String
    Description: The name of the S3 Bucket where the Sitecore resources (instalation files, license file, etc.) reside.
  SCResourcesPrefix:
    Type: String
    Description: The prefix for the sitecore install files. 
    Default: resources/
  SCLicensePrefix:
    Type: String
    Description: "The prefix for the sitecore licence.zip file. eg: license/" 
    Default: license/
  SOLRCorePrefix: 
    Type: String
    Description: The prefix used for the SOLR Cores
  SOLRUrl:
    Description: The URL of your Solr server/cluster. 
    Type: String 
    Default: ''
  EnvironmentType: 
    Description: The type of deployment
    AllowedValues:
      - Production
      - Development
    Default: Production
    Type: String
  SCLogLevel: 
    AllowedValues:
      - Information
      - Debug
      - Error
      - Warning
      - None
    Default: Information
    Type: String
  CorsOrigins: 
    Type: String
  EmailNotifications:
    Type: String
  LambdaZipsBucketName:
    Type: String
    Default: ''
# RDS MS SQL
  DBAutoMinorVersionUpgrade: 
    AllowedValues: 
      - 'true'
      - 'false'
    Default: 'true'
    Description: Select true/false to setup Auto Minor Version upgrade.
    Type: String
  DBInstanceClass:
    AllowedValues:
      - db.m5.large
      - db.m5.xlarge
      - db.m5.2xlarge
      - db.m5.4xlarge
      - db.m5.12xlarge
      - db.m5.24xlarge
      - db.m4.large
      - db.m4.xlarge
      - db.m4.2xlarge
      - db.m4.4xlarge
      - db.m4.10xlarge
      - db.m4.16xlarge
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r4.8xlarge
      - db.r4.16xlarge
    ConstraintDescription: Must select a valid database instance type.
    Default: db.r4.2xlarge
    Description: The name of the compute and memory capacity class of the database instance.
    Type: String
  SQLEngineEdition:
    AllowedValues:
      - sqlserver-ee
      - sqlserver-se
      - sqlserver-ex
      - sqlserver-web
    ConstraintDescription: Must select a MSSQL Database Engine Edition.
    Default: sqlserver-se
    Description: MSSQL Database Engine Edition.
    Type: String
  SQLEngineVersion:
    AllowedValues:
      - 14.00.3192.2.v1
      - 14.00.3049.1.v1
      - 14.00.3035.2.v1
      - 14.00.3015.40.v1
      - 14.00.1000.169.v1
    ConstraintDescription: Must select a MSSQL Database Engine Version.
    Default: 14.00.3192.2.v1
    Description: MSSQL Database Engine Version.
    Type: String
  BackupRetentionPeriod:
    Default: 7
    Description: The number of days for which automated backups are retained. Setting this parameter to a positive number enables backups. Setting this parameter to 0 disables automated backups. 
    Type: Number
  VolumeIops:
    Default: '1000'
    Description: Provisioned IOPS for the SQL Data, Logs and TempDb volumes. This
      parameter is only applicable when SQL Server Volume Type is set to "io1"
    MaxValue: '20000'
    MinValue: '100'
    Type: Number
  VolumeSize:
    Default: '500'
    Description: Volume size for the SQL Data, Logs and TempDb volumes, in GiB
    MaxValue: '16000'
    MinValue: '100'
    Type: Number
  VolumeType:
    AllowedValues:
      - gp2
      - io1
    Default: gp2
    Description: Volume type for the SQL Data, Logs and TempDb volumes
    Type: String
# Redis Configuration
  CacheNodeType:
    Description: The instance type the nodes will launch under.
    Type: String
    Default: cache.m4.large
    AllowedValues:
      - cache.t2.micro
      - cache.t2.small
      - cache.t2.medium
      - cache.m4.large
      - cache.m4.xlarge
      - cache.m4.xlarge
      - cache.m4.4xlarge
      - cache.r4.large
      - cache.r4.xlarge
      - cache.r4.2xlarge
      - cache.r4.4xlarge
      - cache.r4.8xlarge
  RedisPort:
    Type: Number
    Default: 6379
# Quick Start configuration
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name
      can include numbers, lowercase letters, uppercase letters, and hyphens (-).
      It cannot start or end with a hyphen (-).
    Type: String
  QSS3BucketRegion:
    Default: 'us-east-1'
    Description: 'The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value.'
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-sitecore-xp/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String
Rules:
  CDInstanceNumbers:
    Assertions:
      - AssertDescription: Maximum number of Content Delivery instances must be larger than the minimum number specified.
        Assert: !Not [!Equals [!Ref CDMinSize, !Ref CDMaxSize]]
  CMInstanceNumbers:
    Assertions:
      - AssertDescription: Maximum number of Content Management instances must be larger than the minimum number specified.
        Assert: !Not [!Equals [!Ref CMMinSize, !Ref CMMaxSize]]

Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: 
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones:
          !Join
          - ','
          - !Ref AvailabilityZones
        NumberOfAZs: '2'
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1ACIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2ACIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        VPCCIDR: !Ref VPCCIDR
  RDGWStack:
    # DependsOn: VPCStack
    Type: AWS::CloudFormation::Stack
    Properties: 
      TemplateURL: 
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-microsoft-rdgateway/templates/rdgw-standalone.template'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AdminPassword: !Ref AdminPassword
        AdminUser: !Ref AdminUser
        DomainDNSName: !Ref DomainDNSName
        KeyPairName: !Ref KeyPairName
        NumberOfRDGWHosts: !Ref NumberOfRDGWHosts
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Sub ${QSS3KeyPrefix}submodules/quickstart-microsoft-rdgateway/
        RDGWInstanceType: !Ref RDGWInstanceType
        RDGWCIDR: !Ref RDGWCIDR
        VPCID: !GetAtt VPCStack.Outputs.VPCID
  SitecoreStack:
    # DependsOn: RDGWStack
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: 
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/sitecore-xp-existing-vpc.template.yaml'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        VPCCIDR: !Ref VPCCIDR
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        PrivateSubnet1A: !GetAtt VPCStack.Outputs.PrivateSubnet1AID 
        PrivateSubnet2A: !GetAtt VPCStack.Outputs.PrivateSubnet2AID 
        PublicSubnet1: !GetAtt VPCStack.Outputs.PublicSubnet1ID 
        PublicSubnet2: !GetAtt VPCStack.Outputs.PublicSubnet2ID 
        ExternalCertificateARN: !Ref ExternalCertificateARN
        CDDNSName: !Ref CDDNSName
        CMDNSName: !Ref CMDNSName
        ISDNSName: !Ref ISDNSName
        IntDNS: !Ref IntDNS
        CDMinSize: !Ref CDMinSize
        CDMaxSize: !Ref CDMaxSize
        CDDesiredCapacity: !Ref CDDesiredCapacity
        CDInstanceType: !Ref CDInstanceType
        CDScalingMetric: !Ref CDScalingMetric
        CDScalingMetricValue: !Ref CDScalingMetricValue
        CMMinSize: !Ref CMMinSize
        CMMaxSize: !Ref CMMaxSize
        CMInstanceType: !Ref CMInstanceType
        CMScalingMetric: !Ref CMScalingMetric
        CMScalingMetricValue: !Ref CMScalingMetricValue
        SitecoreKeyPair: !Ref SitecoreKeyPair
        SitecorePrefix: !Ref SitecorePrefix
        SitecoreS3Bucket: !Ref SitecoreS3Bucket
        SCResourcesPrefix: !Ref SCResourcesPrefix
        SCLicensePrefix: !Ref SCLicensePrefix
        SOLRCorePrefix: !Ref SOLRCorePrefix
        SOLRUrl: !Ref SOLRUrl
        EnvironmentType: !Ref EnvironmentType
        SCLogLevel: !Ref SCLogLevel
        CorsOrigins: !Ref CorsOrigins
        EmailNotifications: !Ref EmailNotifications
        LambdaZipsBucketName: !Ref LambdaZipsBucketName
        DBInstanceClass: !Ref DBInstanceClass
        DBAutoMinorVersionUpgrade: !Ref DBAutoMinorVersionUpgrade
        SQLEngineEdition: !Ref SQLEngineEdition
        SQLEngineVersion: !Ref SQLEngineVersion
        VolumeSize: !Ref VolumeSize
        VolumeType: !Ref VolumeType
        VolumeIops: !Ref VolumeIops
        BackupRetentionPeriod: !Ref BackupRetentionPeriod
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        CacheNodeType: !Ref CacheNodeType
        RedisPort: !Ref RedisPort